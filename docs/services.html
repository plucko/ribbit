<!DOCTYPE html>

<html>
<head>
  <title>services.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>services.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> micServices = angular.module(<span class="hljs-string">'micServices'</span>, []);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>‘$q’,’$timeout’,’$http’,’$location’,’$rootScope’,</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
micServices.factory(<span class="hljs-string">'Room'</span>, [<span class="hljs-string">'$http'</span>, <span class="hljs-string">'$q'</span>,<span class="hljs-string">'$timeout'</span>,<span class="hljs-string">'$http'</span>,<span class="hljs-string">'$location'</span>,<span class="hljs-string">'$rootScope'</span>,
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">roomFactory</span><span class="hljs-params">($http, $q, $timeout, $http, $location, $rootScope)</span> </span>{
  <span class="hljs-keyword">var</span> result = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Taken and adapted from source code found in article
<a href="https://vickev.com/#!/article/authentication-in-single-page-applications-node-js-passportjs-angularjs">https://vickev.com/#!/article/authentication-in-single-page-applications-node-js-passportjs-angularjs</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  

  result.tryToMakeRoom = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(room)</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Initialize a new promise</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> deferred = $q.defer();

    <span class="hljs-keyword">var</span> successCb = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(result)</span> </span>{
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'logging the success result from calling the createRoom function'</span>, result);
      $location.url(<span class="hljs-string">'/presenter'</span>);
    };

    <span class="hljs-keyword">var</span> errorCb = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> </span>{
      <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'logging the error from calling the createRoom function'</span>, err);
      $location.url(<span class="hljs-string">'/main'</span>);
    };

    <span class="hljs-keyword">var</span> notifyCb = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(result)</span> </span>{
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'logging the notification result from calling the createRoom function'</span>, result);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Make an AJAX call to check if the user is logged in</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $http.post(<span class="hljs-string">'/rooms'</span>, {roomname: room}).success(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(result)</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Authenticated</p>

            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Interacts with server code because server will be written something like
app.get(‘/loggedin’, function(req, res) {
res.send(req.isAuthenticated() ? req.user : ‘0’); }); </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (result !== <span class="hljs-string">'0'</span>) {

        <span class="hljs-comment">/*$timeout(deferred.resolve, 0);*/</span>

        $rootScope.details = {<span class="hljs-string">'roomname'</span>: room, <span class="hljs-string">'presenter'</span>: result.rooms[room].presenter};
        $rootScope.message = <span class="hljs-string">'Room successfully created!'</span>;
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'successful post request to /rooms: About to resolve the promise.'</span>);
        deferred.resolve(result);
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Not Authenticated</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">else</span> {
        $rootScope.message = <span class="hljs-string">'Room already exists.'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>$timeout(function(){deferred.reject();}, 0);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        deferred.reject();
        $location.url(<span class="hljs-string">'/main'</span>);
      }
    });

    <span class="hljs-keyword">return</span> deferred.promise.catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> </span>{
        <span class="hljs-built_in">console</span>.error(err);
      })
      .then(successCb, errorCb, notifyCb);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Function to check if the user is the presenter for the room. There should
only be one presenter bound to each room, and anybody trying to request
access to the presenter’s view and controller will be turned away if they
are not the presenter.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  result.returnPresenter = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">($scope, room)</span> </span>{
    <span class="hljs-keyword">var</span> deferred = $q.defer();

    <span class="hljs-keyword">var</span> successCb = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(result)</span> </span>{
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'logging returnPresenter function\'s success result:'</span>, result);
      $scope.room = result;
      $location.url(<span class="hljs-string">'/audience'</span>);
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'inside the joinRoom function, logging out $scope.room: '</span>, $scope.room);
      <span class="hljs-keyword">return</span> result;
    };

    <span class="hljs-keyword">var</span> errorCb = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> </span>{
      <span class="hljs-built_in">console</span>.error(err);
      $location.url(<span class="hljs-string">'/main'</span>);
    };

    <span class="hljs-keyword">var</span> notifyCb = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(result)</span> </span>{
      <span class="hljs-built_in">console</span>.log(result);
    };

    $http.post(<span class="hljs-string">'/rooms/asAudience'</span>, {roomname: room}).success(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(result)</span></span>{
      <span class="hljs-keyword">if</span> (result !== <span class="hljs-string">'0'</span>) {
        $rootScope.message = <span class="hljs-string">'Found the room! Connecting you now.'</span>;
        $rootScope.details = result;
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Found room and returning room info (result object)'</span>, result);
        deferred.resolve(result);
      } <span class="hljs-keyword">else</span> {
        $rootScope.message = <span class="hljs-string">'Room does not exist!'</span>;
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Did not find room, returning room info (result object)'</span>, result);
        deferred.reject(result);
        $location.url(<span class="hljs-string">'#/main'</span>);
      } 
    });

    <span class="hljs-keyword">return</span> deferred.promise.catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> </span>{
        <span class="hljs-built_in">console</span>.error(err);
      }).then(successCb, errorCb, notifyCb);
  };

  <span class="hljs-keyword">return</span> result;

}]);

micServices.factory(<span class="hljs-string">'Auth'</span>, [<span class="hljs-string">'$http'</span>, <span class="hljs-string">'$q'</span>,<span class="hljs-string">'$timeout'</span>,<span class="hljs-string">'$http'</span>,<span class="hljs-string">'$location'</span>,<span class="hljs-string">'$rootScope'</span>,
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">authFactory</span><span class="hljs-params">($http, $q, $timeout, $http, $location, $rootScope)</span> </span>{
  <span class="hljs-keyword">var</span> result = {};

  result.normalLogin = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(username, password)</span></span>{
    <span class="hljs-keyword">var</span> deferred = $q.defer();

    $http.post(<span class="hljs-string">'/login'</span>, {data: {username: username, password: password}}).success(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(result)</span></span>{
      <span class="hljs-keyword">if</span> (result !== <span class="hljs-string">'0'</span>) {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'result !== 0'</span>, result);
        deferred.resolve(result);
      }
      <span class="hljs-keyword">else</span> {
        $rootScope.message = <span class="hljs-string">'Your username does not exist or your password was wrong.'</span>;
        deferred.reject();
        $location.url(<span class="hljs-string">'/'</span>);
      }
    });

    <span class="hljs-keyword">return</span> deferred.promise;
  };

  result.signup = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(username, password)</span></span>{
    <span class="hljs-keyword">var</span> deferred = $q.defer();

    $http.post(<span class="hljs-string">'/signup'</span>, {data: {username: username, password: password}}).success(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(result)</span></span>{
      <span class="hljs-keyword">if</span> (result !== <span class="hljs-string">'0'</span>) {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'result !== 0'</span>, result);
        deferred.resolve(result);
      }
      <span class="hljs-keyword">else</span> {
        $rootScope.message = <span class="hljs-string">'Username has already been taken.'</span>;
        deferred.reject();
        $location.url(<span class="hljs-string">'/'</span>);
      }
    });

    <span class="hljs-keyword">return</span> deferred.promise;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>  .get(‘/auth’, {headers: {‘Access-Control-Allow-Origin’: ‘<a href="http://127.0.0.1:8000/">http://127.0.0.1:8000/</a>‘ }}).success(function(result){
  if (result !== ‘0’)
    deferred.resolve(result);
  else {
    $rootScope.message = ‘gitLogin failed, don\’t know why.’;
    deferred.reject();
    $location.url(‘/‘);
  }
});</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>

  <span class="hljs-keyword">return</span> result;

}]);</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
